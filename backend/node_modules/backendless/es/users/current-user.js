'use strict';

Object.defineProperty(exports, "__esModule", {
  value: true
});
exports.setLocalCurrentUser = setLocalCurrentUser;
exports.getLocalCurrentUser = getLocalCurrentUser;
exports.getCurrentUserToken = getCurrentUserToken;
exports.getCurrentUser = getCurrentUser;
exports.isValidLogin = isValidLogin;
exports.loggedInUser = loggedInUser;

var _utils = require('../utils');

var _utils2 = _interopRequireDefault(_utils);

var _async = require('../request/async');

var _async2 = _interopRequireDefault(_async);

var _utils3 = require('./utils');

function _interopRequireDefault(obj) { return obj && obj.__esModule ? obj : { default: obj }; }

function setLocalCurrentUser(user) {
  this.currentUser = user || null;

  this.app.RT.updateUserTokenIfNeeded();
}

function getLocalCurrentUser() {
  return this.currentUser;
}

function getCurrentUserToken() {
  if (this.currentUser && this.currentUser['user-token']) {
    return this.currentUser['user-token'] || null;
  }

  return this.app.LocalCache.get('user-token') || null;
}

function getCurrentUser(asyncHandler) {
  var _this = this;

  if (this.currentUser) {
    var userFromResponse = _utils3.getUserFromResponse.call(this, this.currentUser);

    return asyncHandler ? asyncHandler.success(userFromResponse) : userFromResponse;
  }

  if (this.currentUserRequest && asyncHandler) {
    this.currentUserRequest.then(function (result) {
      return asyncHandler.success(result);
    }).catch(function (error) {
      return asyncHandler.fault(error);
    });

    return this.currentUserRequest;
  }

  var stayLoggedIn = this.app.LocalCache.get('stayLoggedIn');
  var currentUserId = stayLoggedIn && this.app.LocalCache.get('current-user-id');

  if (currentUserId) {
    var Data = this.app.Data;
    var User = this.app.User;

    return this.currentUserRequest = Data.of(User).findById(currentUserId).then(function (result) {
      _this.currentUserRequest = null;

      _this.currentUser = _utils3.getUserFromResponse.call(_this, result);

      return asyncHandler.success(_this.currentUser);
    }).catch(function (error) {
      _this.currentUserRequest = null;

      asyncHandler.fault(error);

      throw error;
    });
  }

  return asyncHandler ? asyncHandler.success(null) : null;
}

function isValidLogin() /** async */{
  var userToken = this.getCurrentUserToken();
  var responder = _utils2.default.extractResponder(arguments);
  var isAsync = !!responder;

  if (userToken) {
    if (!isAsync) {
      try {
        var result = this.app.request.get({
          url: this.app.urls.userTokenCheck(userToken)
        });
        return !!result;
      } catch (e) {
        return false;
      }
    }

    return this.app.request.get({
      url: this.app.urls.userTokenCheck(userToken),
      isAsync: isAsync,
      asyncHandler: responder
    });
  }

  if (!isAsync) {
    return !!this.getCurrentUser();
  }

  this.getCurrentUser(new _async2.default(function (user) {
    return responder.success(!!user);
  }, function () {
    return responder.success(false);
  }));
}

function loggedInUser() {
  return this.app.LocalCache.get('current-user-id');
}